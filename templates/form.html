<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Registro de depósito/transferencia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body{font-family:system-ui,Arial,sans-serif;max-width:880px;margin:24px auto;padding:0 16px;}
    fieldset{border:1px solid #ddd;padding:12px;border-radius:8px;margin-bottom:16px;}
    legend{padding:0 8px;font-weight:600;}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1 1 260px}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .card{border:1px solid #ddd;border-radius:12px;padding:12px}
    .card input[type="radio"]{transform:scale(1.2);margin-right:8px}
    label{display:block;margin:6px 0 4px}
    input[type="text"], input[type="date"]{width:100%;padding:8px;border:1px solid #ccc;border-radius:8px}
    input[type="file"]{margin-top:4px}
    .hint{color:#666;font-size:12px}
    .muted{color:#777}
    .hidden{display:none}
    button{background:#1a73e8;color:#fff;border:none;padding:10px 16px;border-radius:10px;cursor:pointer}
    button:hover{opacity:.92}
    a{color:#1a73e8;text-decoration:none}
  </style>
</head>
<body>
  <h1>Registrar depósito / transferencia</h1>

  <form action="/submit" method="post" enctype="multipart/form-data" id="mainForm">
    <div class="row">
      <div class="col">
        <label>Fecha</label>
        <input type="date" name="fecha_iso" id="fecha_iso">
      </div>
      <div class="col">
        <label>Banco</label>
        <div>
          <label><input type="radio" name="banco" value="BBVA" required> BBVA</label>
          <label><input type="radio" name="banco" value="Banorte"> Banorte</label>
          <label><input type="radio" name="banco" value="Azteca"> Azteca</label>
          <label><input type="radio" name="banco" value="Scotiabank"> Scotiabank</label>
          <label><input type="radio" name="banco" value="Santander"> Santander</label>
        </div>
      </div>
      <div class="col">
        <label>Forma de pago</label>
        <div>
          <label><input type="radio" name="forma_pago" value="Depósito" required> Depósito</label>
          <label><input type="radio" name="forma_pago" value="Transferencia"> Transferencia</label>
        </div>
      </div>
    </div>

    <fieldset>
      <legend>Producto e Importe</legend>
      <div>
        <label>Producto</label>
        <label><input type="radio" name="producto" value="Pago de servicios" required> Pago de servicios</label>
        <label><input type="radio" name="producto" value="TAE"> TAE</label>
      </div>
      <div class="col" style="margin-top:8px;">
        <label>Importe</label>
        <input id="importe" type="text" name="importe" placeholder="$0.00"
               inputmode="decimal" autocomplete="off"
               pattern="[0-9\$\s\.,]+"
               title="Monto válido. Ej: 1234.56 o $1,234.56" required>
        <input type="hidden" id="importe_clean" name="importe_clean" value="">
        <div class="hint">Ejemplo: $1,234.56</div>
      </div>
    </fieldset>

    <fieldset id="bbvaTipoBox" class="hidden">
      <legend>Tipo de comprobante BBVA</legend>
      <label><input type="radio" name="tipo_bbva" value="practicaja"> Practicaja</label>
      <label><input type="radio" name="tipo_bbva" value="ventanilla"> Ventanilla</label>
    </fieldset>

    <fieldset id="foliosBox">
      <legend>Folio / Autorización</legend>

      <!-- Otros bancos (NUMÉRICO) -->
      <div id="otrosBancosBox">
        <label>Folio / Referencia (otros bancos)</label>
        <input id="folio_otros" type="text" name="folio"
               inputmode="numeric" autocomplete="off"
               minlength="1" maxlength="20" pattern="[0-9]{1,20}"
               title="Solo números (1 a 20 dígitos)">
      </div>

      <!-- BBVA practicaja (numérico) -->
      <div id="bbvaPracticajaBox" class="hidden">
        <div class="row">
          <div class="col">
            <label>Folio (solo números)</label>
            <input id="folio_bbva" type="text" inputmode="numeric" autocomplete="off"
                   minlength="1" maxlength="20" pattern="[0-9]{1,20}"
                   title="Solo números (1 a 20 dígitos)" data-bind="folio">
          </div>
          <div class="col">
            <label>Autorización (solo números)</label>
            <input id="aut_bbva" type="text" inputmode="numeric" autocomplete="off"
                   minlength="1" maxlength="20" pattern="[0-9]{1,20}"
                   title="Solo números (1 a 20 dígitos)" data-bind="autorizacion">
          </div>
        </div>
      </div>

      <!-- BBVA ventanilla (numérico) -->
      <div id="bbvaVentanillaBox" class="hidden">
        <label>Folio o Movimiento (solo números)</label>
        <input id="mov_bbva" type="text" inputmode="numeric" autocomplete="off"
               minlength="1" maxlength="20" pattern="[0-9]{1,20}"
               title="Solo números (1 a 20 dígitos)" data-bind="folio_movimiento">
        <div class="hint">Si ventanilla, solo llena este campo y deja Autorización vacío.</div>
      </div>

      <div class="hint">Aquí irá la imagen de ejemplo del folio (pendiente de diseño).</div>
    </fieldset>

    <fieldset>
      <legend>Usuario y Cliente</legend>
      <div class="row">
        <div class="col">
          <label>Número de usuario</label>
          <input type="text" id="numero_usuario" name="numero_usuario" placeholder="15333"
                 inputmode="numeric" autocomplete="off"
                 pattern="[0-9]+" title="Solo números" required>
        </div>
        <div class="col">
          <label>Requiere factura</label>
          <input type="checkbox" name="requiere_factura">
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>Realizó (quién hizo el depósito)</label>
          <input type="text" name="realizo" placeholder="Nombre de quien depositó">
        </div>
      </div>
      <label>Observaciones</label>
      <input type="text" name="observaciones" placeholder="Opcional">

      <div style="margin-top:8px;">
        <div class="muted">Clientes disponibles para este usuario:</div>
        <div id="clientesCards" class="cards"></div>
        <input type="hidden" name="cliente_id" id="cliente_id">
        <input type="hidden" name="cliente_nombre" id="cliente_nombre">
        <div id="clientesMsg" class="hint"></div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Comprobante</legend>
      <input type="file" name="comprobante" accept="image/*,application/pdf" required>
    </fieldset>

    <div class="row" style="align-items:center; gap:12px;">
      <button type="submit">Guardar</button>
      <a href="https://multisaldo.com.mx" target="_self">regresar a multisaldo</a>
    </div>
  </form>

  <script>
    // === Utilidades de validación ===
    function onlyDigits(el){ el.value = el.value.replace(/\D+/g,''); el.setCustomValidity(''); }
    function setNumericValidity(el){
      if(!el) return;
      el.addEventListener('input', ()=>onlyDigits(el));
      el.addEventListener('invalid', ()=>{
        if(el.validity.patternMismatch || el.validity.typeMismatch){
          el.setCustomValidity('Solo se permiten números (0-9).');
        }else if(el.validity.valueMissing){
          el.setCustomValidity('Este campo es obligatorio.');
        }
      });
      el.addEventListener('blur', ()=>el.setCustomValidity(''));
    }
    function normalizeAmountToHidden(){
      const raw = (document.getElementById('importe').value || '').trim();
      // deja solo dígitos y UN punto decimal
      let v = raw.replace(/[^0-9.,]/g,'').replace(',', '.');
      const parts = v.split('.');
      if(parts.length > 2){
        const last = parts.pop();
        v = parts.join('') + '.' + last;
      }
      document.getElementById('importe_clean').value = v;
    }

    // fecha hoy por defecto
    (function(){
      const f = document.getElementById('fecha_iso');
      const today = new Date();
      f.value = today.toISOString().slice(0,10);
    })();

    const bancoRadios = document.querySelectorAll('input[name="banco"]');
    const tipoBBVARadios = document.querySelectorAll('input[name="tipo_bbva"]');
    const productoRadios = document.querySelectorAll('input[name="producto"]');

    const tipoBBVABox = document.getElementById('bbvaTipoBox');
    const otrosBancosBox = document.getElementById('otrosBancosBox');
    const bbvaPractiBox = document.getElementById('bbvaPracticajaBox');
    const bbvaVentanillaBox = document.getElementById('bbvaVentanillaBox');
    const foliosBox = document.getElementById('foliosBox');

    function toggleBankUI() {
      const bancoSel = document.querySelector('input[name="banco"]:checked');
      const productoSel = document.querySelector('input[name="producto"]:checked');
      const banco = bancoSel ? bancoSel.value : "";
      const producto = productoSel ? productoSel.value : "";

      const folioOtros = document.getElementById('folio_otros');
      const folioBBVA  = document.getElementById('folio_bbva');
      const autBBVA    = document.getElementById('aut_bbva');
      const movBBVA    = document.getElementById('mov_bbva');

      if (producto === "TAE") {
        foliosBox.classList.add('hidden');
        tipoBBVABox.classList.add('hidden');
        bbvaPractiBox.classList.add('hidden');
        bbvaVentanillaBox.classList.add('hidden');
        otrosBancosBox.classList.add('hidden');
        [folioOtros, folioBBVA, autBBVA, movBBVA].forEach(el=>{ if(el){ el.required=false; el.value=''; }});
        return;
      }

      foliosBox.classList.remove('hidden');

      if (banco === "BBVA") {
        tipoBBVABox.classList.remove('hidden');
        otrosBancosBox.classList.add('hidden');
        if (folioOtros) folioOtros.required = false;
      } else {
        tipoBBVABox.classList.add('hidden');
        bbvaPractiBox.classList.add('hidden');
        bbvaVentanillaBox.classList.add('hidden');
        otrosBancosBox.classList.remove('hidden');
        if (folioOtros) folioOtros.required = true; // numérico requerido para otros bancos
      }
    }

    function toggleBBVAType() {
      const t = document.querySelector('input[name="tipo_bbva"]:checked');
      const tipo = t ? t.value : "";
      const productoSel = document.querySelector('input[name="producto"]:checked');
      const producto = productoSel ? productoSel.value : "";

      const folioBBVA  = document.getElementById('folio_bbva');
      const autBBVA    = document.getElementById('aut_bbva');
      const movBBVA    = document.getElementById('mov_bbva');

      if (producto === "TAE") {
        bbvaPractiBox.classList.add('hidden');
        bbvaVentanillaBox.classList.add('hidden');
        [folioBBVA, autBBVA, movBBVA].forEach(el=>{ if(el){ el.required=false; el.value=''; }});
        return;
      }

      if (tipo === "practicaja") {
        bbvaPractiBox.classList.remove('hidden');
        bbvaVentanillaBox.classList.add('hidden');
        if (folioBBVA) folioBBVA.required = true;
        if (autBBVA)   autBBVA.required   = true;
        if (movBBVA)   { movBBVA.required = false; movBBVA.value=''; }
      } else if (tipo === "ventanilla") {
        bbvaPractiBox.classList.add('hidden');
        bbvaVentanillaBox.classList.remove('hidden');
        if (movBBVA)   movBBVA.required   = true;
        if (folioBBVA) { folioBBVA.required = false; folioBBVA.value=''; }
        if (autBBVA)   { autBBVA.required   = false; autBBVA.value=''; }
      } else {
        bbvaPractiBox.classList.add('hidden');
        bbvaVentanillaBox.classList.add('hidden');
        [folioBBVA, autBBVA, movBBVA].forEach(el=>{ if(el){ el.required=false; }});
      }
    }

    // clientes
    const numUsuario = document.getElementById('numero_usuario');
    const cardsWrap = document.getElementById('clientesCards');
    const clienteIdInput = document.getElementById('cliente_id');
    const clienteNombreInput = document.getElementById('cliente_nombre');
    const clientesMsg = document.getElementById('clientesMsg');

    async function fetchClientes() {
      const n = numUsuario.value.trim();
      cardsWrap.innerHTML = "";
      clienteIdInput.value = "";
      clienteNombreInput.value = "";
      clientesMsg.textContent = "";
      if (!n) return;
      try {
        const res = await fetch(`/api/clientes?usuario=${encodeURIComponent(n)}`);
        const data = await res.json();
        if (!data.ok) { clientesMsg.textContent = "No se pudieron obtener clientes."; return; }
        const items = data.items || [];
        if (items.length === 0) {
          clientesMsg.textContent = "No hay clientes registrados para este usuario. Espera a que los registremos.";
          return;
        }
        items.forEach((it, i) => {
          const div = document.createElement('div');
          div.className = 'card';
          div.innerHTML = `
            <label style="display:flex;gap:8px;align-items:start;cursor:pointer;">
              <input type="radio" name="sel_cliente" value="${i}">
              <div>
                <div><strong>${(it.cliente_nombre || '(sin nombre)')}</strong></div>
                <div class="hint">ID: ${(it.cliente_id || '(sin id)')}</div>
                ${it.rfc ? `<div class="hint">RFC: ${it.rfc}</div>` : ''}
              </div>
            </label>`;
          cardsWrap.appendChild(div);
        });
        cardsWrap.addEventListener('change', (ev) => {
          const sel = document.querySelector('input[name="sel_cliente"]:checked');
          if (!sel) return;
          const idx = parseInt(sel.value, 10);
          const it = items[idx];
          clienteIdInput.value = it.cliente_id || '';
          clienteNombreInput.value = it.cliente_nombre || '';
        }, { once: true });
      } catch {
        clientesMsg.textContent = "Error de red al consultar clientes.";
      }
    }

    // Hook de validaciones y normalizaciones
    document.addEventListener('DOMContentLoaded', () => {
      // fecha por defecto
      const f = document.getElementById('fecha_iso');
      f.value = new Date().toISOString().slice(0,10);

      // Sanitiza numéricos
      ['folio_otros','folio_bbva','aut_bbva','mov_bbva','numero_usuario'].forEach(id=>{
        setNumericValidity(document.getElementById(id));
      });

      // Normaliza importe a hidden limpio
      const imp = document.getElementById('importe');
      ['input','blur','change'].forEach(ev=> imp.addEventListener(ev, normalizeAmountToHidden));
      normalizeAmountToHidden();

      // Listeners de UI
      document.querySelectorAll('input[name="banco"]').forEach(r=>r.addEventListener('change', toggleBankUI));
      document.querySelectorAll('input[name="tipo_bbva"]').forEach(r=>r.addEventListener('change', toggleBBVAType));
      document.querySelectorAll('input[name="producto"]').forEach(r=>r.addEventListener('change', ()=>{ toggleBankUI(); toggleBBVAType(); }));

      // Carga de clientes
      numUsuario.addEventListener('blur', fetchClientes);

      // Estado inicial
      toggleBankUI(); 
      toggleBBVAType();
    });
  </script>
</body>
</html>
