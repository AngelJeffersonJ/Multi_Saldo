{% extends "base.html" %}
{% block title %}Opciones fiscales · Admin{% endblock %}

{% block content %}
<div class="container-xxl">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="mb-0"><i class="bi bi-receipt-cutoff me-2"></i>Opciones fiscales por usuario</h3>
    <a href="{{ url_for('admin.registros') }}" class="btn btn-outline-secondary">
      <i class="bi bi-table"></i> Regresar a registros
    </a>
  </div>

  <!-- Buscador (GET) – lo interceptamos por JS y no recargamos -->
  <form id="searchForm" class="row g-2 align-items-end mb-4" method="get">
    <div class="col-sm-4">
      <label class="form-label">Número de usuario (5 dígitos)</label>
      <input id="nuInput" name="numero_usuario" value="{{ q or '' }}" class="form-control"
             inputmode="numeric" pattern="\d{5}" placeholder="12345">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary"><i class="bi bi-search"></i> Buscar</button>
    </div>
  </form>

  <div id="alertBox" class="alert alert-danger d-none" role="alert"></div>

  <!-- Alta -->
  <div class="card shadow-sm mb-4">
    <div class="card-header">
      <strong>Agregar opción para un usuario</strong>
    </div>
    <div class="card-body">
      <form id="addForm" method="post" class="row g-3" action="{{ url_for('admin.fiscales') }}">
        <div class="col-sm-3">
          <label class="form-label">Usuario (5 dígitos)</label>
          <input id="addNu" name="numero_usuario" value="{{ q or '' }}" class="form-control"
                 inputmode="numeric" pattern="\d{5}" required>
        </div>
        <div class="col-sm-4">
          <label class="form-label">Razón social (título)</label>
          <input name="titulo" class="form-control" placeholder="Empresa SA de CV" required>
        </div>
        <div class="col-sm-3">
          <label class="form-label">RFC</label>
          <input name="rfc" class="form-control" placeholder="AAA010101AAA" maxlength="13">
        </div>
        <div class="col-sm-4">
          <label class="form-label">Email de facturación</label>
          <input name="email" type="email" class="form-control" placeholder="facturas@dominio.com">
        </div>
        <div class="col-12">
          <button class="btn btn-success"><i class="bi bi-plus-lg"></i> Guardar opción</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Tabla -->
  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <strong>Opciones registradas <span id="tableTitle">{% if q %}para el usuario {{ q }}{% endif %}</span></strong>
      <span class="text-secondary small">Edita y guarda por fila</span>
    </div>
    <div class="table-responsive">
      <table class="table table-hover table-sm align-middle mb-0">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Usuario</th>
            <th>Razón social</th>
            <th>RFC</th>
            <th>Email</th>
            <th class="text-end">Acciones</th>
          </tr>
        </thead>
        <tbody id="tbodyOpciones">
          {# Fallback SSR por si se desactiva JS #}
          {% for o in opciones %}
          <tr>
            <td>{{ o.id }}</td>
            <td>{{ o.numero_usuario }}</td>
            <td colspan="4">
              <form method="post" action="{{ url_for('admin.fiscales_update', oid=o.id) }}" class="row g-2 align-items-center">
                <div class="col-md-4">
                  <input name="titulo" class="form-control form-control-sm" value="{{ o.titulo }}">
                </div>
                <div class="col-md-3">
                  <input name="rfc" class="form-control form-control-sm" value="{{ o.rfc or '' }}" maxlength="13">
                </div>
                <div class="col-md-3">
                  <input name="email" type="email" class="form-control form-control-sm" value="{{ o.email or '' }}">
                </div>
                <div class="col-md-2 text-end">
                  <button class="btn btn-sm btn-primary"><i class="bi bi-check2"></i> Guardar</button>
                  <button form="del-{{o.id}}" class="btn btn-sm btn-outline-danger" type="submit">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </form>
              <form id="del-{{o.id}}" method="post" action="{{ url_for('admin.fiscales_delete', oid=o.id) }}"></form>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="6" class="text-center text-secondary py-4">Sin resultados.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block body_extra %}
<script>
(() => {
  const $alert = document.getElementById('alertBox');
  function err(msg) {
    console.error(msg);
    $alert.textContent = typeof msg === 'string' ? msg : (msg?.message || 'Error');
    $alert.classList.remove('d-none');
    setTimeout(() => $alert.classList.add('d-none'), 5000);
  }

  const nuInput   = document.getElementById('nuInput');
  const addNu     = document.getElementById('addNu');
  const tbody     = document.getElementById('tbodyOpciones');
  const tableTitle= document.getElementById('tableTitle');
  const searchFrm = document.getElementById('searchForm');
  const addFrm    = document.getElementById('addForm');

  let currentNU = (nuInput.value || '').trim();

  function debounce(fn, ms=350) {
    let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); };
  }

  async function loadOpciones(nu) {
    if (!/^\d{5}$/.test(nu)) {
      tbody.innerHTML = `<tr><td colspan="6" class="text-center text-secondary py-4">Ingresa un número de 5 dígitos.</td></tr>`;
      tableTitle.textContent = '';
      return;
    }
    try {
      const r = await fetch(`/api/opciones_factura?numero_usuario=${encodeURIComponent(nu)}`, {credentials:'same-origin'});
      if (!r.ok) throw new Error(`GET ${r.status}`);
      const data = await r.json();
      renderRows(data, nu);
      // Sincroniza el “Alta” con el mismo usuario
      addNu.value = nu;
      // (Opcional) avisamos a /admin/registros que hubo cambios
      try { localStorage.setItem('ms_fiscales_touch', String(Date.now())); } catch {}
    } catch (e) { err(e); }
  }

  function renderRows(items, nu) {
    tableTitle.textContent = items.length ? `para el usuario ${nu}` : (nu ? `para el usuario ${nu} (sin resultados)` : '');
    if (!items.length) {
      tbody.innerHTML = `<tr><td colspan="6" class="text-center text-secondary py-4">Sin resultados.</td></tr>`;
      return;
    }
    const rows = items.map(it => `
      <tr data-oid="${it.id}">
        <td>${it.id}</td>
        <td>${nu}</td>
        <td colspan="4">
          <form class="row g-2 align-items-center js-update" action="/admin/fiscales/${it.id}/update" method="post">
            <div class="col-md-4">
              <input name="titulo" class="form-control form-control-sm" value="${escapeHTML(it.titulo || '')}">
            </div>
            <div class="col-md-3">
              <input name="rfc" class="form-control form-control-sm" value="${escapeHTML(it.rfc || '')}" maxlength="13">
            </div>
            <div class="col-md-3">
              <input name="email" type="email" class="form-control form-control-sm" value="${escapeHTML(it.email || '')}">
            </div>
            <div class="col-md-2 text-end">
              <button class="btn btn-sm btn-primary"><i class="bi bi-check2"></i> Guardar</button>
              <button class="btn btn-sm btn-outline-danger js-delete" data-url="/admin/fiscales/${it.id}/delete" type="button">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </form>
        </td>
      </tr>
    `).join('');
    tbody.innerHTML = rows;

    // Bind update/delete
    tbody.querySelectorAll('form.js-update').forEach(f => {
      f.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(f);
        try {
          const r = await fetch(f.action, { method:'POST', body: fd, credentials:'same-origin' });
          if (!r.ok) throw new Error(`POST ${r.status}`);
          await loadOpciones(currentNU);
        } catch (ex) { err(ex); }
      });
    });
    tbody.querySelectorAll('.js-delete').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm('¿Eliminar esta opción fiscal?')) return;
        try {
          const r = await fetch(btn.dataset.url, { method:'POST', credentials:'same-origin' });
          if (!r.ok) throw new Error(`POST ${r.status}`);
          await loadOpciones(currentNU);
        } catch (ex) { err(ex); }
      });
    });
  }

  function escapeHTML(s) {
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');
  }

  // Buscar (sin recargar)
  searchFrm.addEventListener('submit', (e) => {
    e.preventDefault();
    currentNU = (nuInput.value || '').trim();
    loadOpciones(currentNU);
  });

  // Autocarga cuando hay 5 dígitos
  nuInput.addEventListener('input', debounce(() => {
    const v = (nuInput.value || '').trim();
    if (/^\d{5}$/.test(v)) {
      currentNU = v;
      loadOpciones(currentNU);
    }
  }, 350));

  // Alta (sin recargar)
  addFrm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(addFrm);
    try {
      const r = await fetch(addFrm.action, { method:'POST', body: fd, credentials:'same-origin' });
      if (!r.ok) throw new Error(`POST ${r.status}`);
      // refrescamos la lista del usuario capturado
      currentNU = (fd.get('numero_usuario') || '').toString();
      nuInput.value = currentNU;
      await loadOpciones(currentNU);
      // limpiamos campos (menos el usuario)
      addFrm.querySelector('[name="titulo"]').value = '';
      addFrm.querySelector('[name="rfc"]').value = '';
      addFrm.querySelector('[name="email"]').value = '';
    } catch (ex) { err(ex); }
  });

  // Carga inicial si ya venía un número
  if (/^\d{5}$/.test(currentNU)) loadOpciones(currentNU);
})();
</script>
{% endblock %}
