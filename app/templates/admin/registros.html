<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registros de Dep√≥sitos</title>

  <!-- Tabulator -->
  <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
  <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>

  <style>
    :root{
      --bg:#0b0f14; --panel:#121923; --muted:#8b9bb4; --text:#e7edf5; --brand:#6ee7b7;
      --line:#223245; --btn:#162231; --btn-h:#1d2d40; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Helvetica,Arial,sans-serif}
    .topbar{display:flex;align-items:center;gap:.75rem;padding:.75rem 1rem;border-bottom:1px solid var(--line);background:var(--panel)}
    .brand{display:flex;align-items:center;gap:.5rem;font-weight:700}
    .pill{background:#0f172a;border:1px solid var(--line);padding:.35rem .6rem;border-radius:.5rem;color:var(--muted)}
    .wrap{padding:1rem;max-width:1400px;margin:0 auto}
    .title{display:flex;align-items:center;gap:.6rem;font-size:1.6rem;font-weight:800;margin:.4rem 0 1rem}
    .hint{background:#0f172a;border:1px solid var(--line);padding:.6rem .8rem;border-radius:.6rem;color:var(--muted)}
    .bar{display:flex;gap:.5rem;flex-wrap:wrap;margin:.9rem 0}
    .input,.select{background:var(--bg);border:1px solid var(--line);color:var(--text);border-radius:.5rem;padding:.5rem .6rem}
    .btn{background:var(--btn);border:1px solid var(--line);padding:.5rem .8rem;border-radius:.5rem;color:var(--text);cursor:pointer}
    .btn:hover{background:var(--btn-h)}
    .btn-danger{border-color:#7f1d1d;background:#1b0b0b;color:#fecaca}
    .right{margin-left:auto}
    .status{font-size:.9rem;color:var(--muted)}
    /* Tabulator tweaks */
    .tabulator{background:var(--panel);border:1px solid var(--line)}
    .tabulator .tabulator-header{background:#0d1520;border-bottom:1px solid var(--line)}
    .tabulator .tabulator-col,.tabulator .tabulator-cell{border-right:1px solid #1b2a3f}
    .tabulator .tabulator-row{background:var(--panel)}
    .tabulator .tabulator-row.tabulator-selected{background:#0e1f31}
    .tabulator .tabulator-col .tabulator-header-filter input,
    .tabulator .tabulator-col .tabulator-header-filter select{
      background:#0b0f14;color:var(--text);border:1px solid var(--line);border-radius:.35rem;padding:.25rem .35rem;
    }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="brand">üè¶ Multisaldo</div>
    <span class="pill">Admin</span>
    <div class="right">
      <a class="btn" href="{{ url_for('public.registro') }}">Registro</a>
      <a class="btn btn-danger" href="{{ url_for('admin.logout') }}">Salir</a>
    </div>
  </div>

  <div class="wrap">
    <div class="title">üìä Registros de Dep√≥sitos</div>

    <div class="hint">Doble clic para editar ¬∑ Enter guarda ¬∑ <kbd>Supr</kbd> elimina la fila seleccionada ¬∑ <kbd>Ctrl/Cmd+C / V</kbd> copia/pega.</div>

    <!-- Filtros r√°pidos (se sincronizan con los header filters) -->
    <div class="bar">
      <input id="q-usuario" class="input" placeholder="Usuario (5 d√≠g.)" maxlength="5" pattern="\\d{5}">
      <select id="q-banco" class="select">
        <option value="">Banco (todos)</option>
        <option>BBVA</option><option>Banorte</option><option>Azteca</option><option>Scotiabank</option><option>Santander</option>
      </select>
      <select id="q-forma" class="select">
        <option value="">Forma (todas)</option>
        <option>Deposito</option><option>Transferencia</option>
      </select>
      <button id="btn-clear" class="btn">Limpiar</button>
      <button id="btn-csv" class="btn">CSV</button>
      <span id="status" class="status right">Listo.</span>
    </div>

    <div id="grid"></div>
  </div>

<script>
  // Helpers
  const statusEl = document.getElementById('status');
  function setStatus(t){ statusEl.textContent = t; }

  // Formateador: bot√≥n a comprobante
  function comprobanteFormatter(cell){
    const id = cell.getValue();
    if(!id) return "";
    const url = "{{ url_for('admin.comprobante_link', comp_id=0) }}".replace("0", id);
    return `<a class="btn" href="${url}" target="_blank">Comprobante</a>`;
  }

  // Guardado remoto (PATCH) al editar una celda
  async function saveCell(cell){
    const field = cell.getField();
    const value = cell.getValue();
    const id = cell.getRow().getData().id;

    setStatus("Guardando‚Ä¶");
    try{
      const res = await fetch(`{{ url_for('admin.api_depositos_update', dep_id=0) }}`.replace("0", id), {
        method:"PATCH",
        headers:{"Content-Type":"application/json"},
        credentials:"same-origin",
        body:JSON.stringify({field, value})
      });
      if(!res.ok) throw new Error(await res.text());
      setStatus("Guardado.");
      return true;
    }catch(e){
      console.error(e);
      setStatus("Error al guardar.");
      // revertir valor en UI
      cell.restoreOldValue();
      alert("No se pudo guardar: " + e.message);
      return false;
    }
  }

  // Eliminar fila (DELETE) con tecla Supr
  async function deleteSelected(){
    const row = grid.getSelectedRows()[0];
    if(!row) return;
    const id = row.getData().id;
    if(!confirm(`Eliminar dep√≥sito #${id}?`)) return;

    setStatus("Eliminando‚Ä¶");
    try{
      const res = await fetch(`{{ url_for('admin.api_depositos_delete', dep_id=0) }}`.replace("0", id), {
        method:"DELETE",
        credentials:"same-origin"
      });
      if(!res.ok) throw new Error(await res.text());
      row.delete();
      setStatus("Eliminado.");
    }catch(e){
      console.error(e);
      setStatus("Error al eliminar.");
      alert("No se pudo eliminar: " + e.message);
    }
  }

  // Definici√≥n de columnas ‚Äúmodo Excel‚Äù (editores + validadores)
  const cols = [
    {title:"ID", field:"id", width:70, headerSort:true, hozAlign:"right", headerHozAlign:"center"},
    {title:"Fecha", field:"fecha_operacion", headerFilter:"input", editor:"input",
      validator:["required"],
      headerSort:true, width:130},
    {title:"Banco", field:"banco", headerFilter:"select", headerFilterParams:{
        values:true // genera opciones desde datos
      },
      editor:"select", editorParams:{values:["BBVA","Banorte","Azteca","Scotiabank","Santander"]}, width:140},
    {title:"Forma", field:"forma_pago", headerFilter:"select",
      editor:"select", editorParams:{values:["Deposito","Transferencia"]}, width:140},
    {title:"Producto", field:"producto", headerFilter:"select",
      editor:"select", editorParams:{values:["TAE","Pago de servicios"]}, width:160},
    {title:"Usuario", field:"numero_usuario", headerFilter:"input",
      editor:"input", validator:["required","integer","min:0","max:99999"], width:120},
    {title:"Importe", field:"importe", headerFilter:"input", hozAlign:"right",
      editor:"input", validator:["required"], width:120},
    {title:"BBVA tipo", field:"bbva_tipo", headerFilter:"select",
      editor:"select", editorParams:{values:["","practicaja","caja"]}, width:140},
    {title:"Folio", field:"folio", headerFilter:"input", editor:"input", width:120},
    {title:"Autorizaci√≥n", field:"autorizacion", headerFilter:"input", editor:"input", width:140},
    {title:"Referencia", field:"referencia", headerFilter:"input", editor:"input", width:140},
    {title:"Factura", field:"requiere_factura", headerFilter:"select",
      headerFilterParams:{values:{"":"(todas)","true":"S√≠","false":"No"}},
      formatter:"tickCross", hozAlign:"center", width:90,
      editor:true, mutatorEdit:function(v){ return !!v; }},
    {title:"Estatus", field:"estatus", headerFilter:"input", editor:"input", width:140},
    {title:"Obs.", field:"observaciones", headerFilter:"input", editor:"textarea", width:220},
    {title:"", field:"comprobante_id", formatter:comprobanteFormatter, width:150, hozAlign:"center", headerSort:false},
  ];

  // Construye URL base de la API (sin filtros: los haremos en cliente con headerFilter)
  const API_URL = "{{ url_for('admin.api_depositos_list') }}";

  // Instancia del grid
  const grid = new Tabulator("#grid", {
    ajaxURL: API_URL,
    ajaxConfig: {method:"GET", credentials:"same-origin"},
    layout:"fitDataStretch",
    height:"68vh",
    placeholder:"Sin registros.",
    columns: cols,
    selectable:1,
    movableColumns:true,
    resizableColumns:true,
    clipboard:true,
    clipboardPasteAction:"update",
    history:true, // undo/redo
    persistence:{sort:true, columns:true, filter:true}, // recuerda estado
    headerVisible:true,
    ajaxResponse:function(url, params, data){ setStatus(`Filas: ${data.length}`); return data; },
    ajaxError:function(xhr){ alert(`Error cargando datos (${xhr.status}).`); },
    cellEdited: saveCell,
    keybindings:{
      "delete": deleteSelected
    }
  });

  // Filtros r√°pidos (sincronizan con header filters)
  const qUsuario = document.getElementById('q-usuario');
  const qBanco = document.getElementById('q-banco');
  const qForma = document.getElementById('q-forma');
  function syncQuickFiltersToHeaders(){
    grid.setHeaderFilterValue("numero_usuario", qUsuario.value || "");
    grid.setHeaderFilterValue("banco", qBanco.value || "");
    grid.setHeaderFilterValue("forma_pago", qForma.value || "");
  }
  qUsuario.addEventListener('input', syncQuickFiltersToHeaders);
  qBanco.addEventListener('change', syncQuickFiltersToHeaders);
  qForma.addEventListener('change', syncQuickFiltersToHeaders);

  document.getElementById('btn-clear').onclick = ()=>{
    qUsuario.value=""; qBanco.value=""; qForma.value="";
    grid.clearHeaderFilter();
  };
  document.getElementById('btn-csv').onclick = ()=> grid.download("csv","depositos.csv");

  // Carga inicial
  grid.setData(API_URL);
</script>
</body>
</html>
