{% extends "base.html" %}
{% block title %}Admin · Registros{% endblock %}

{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
  <h3 class="m-0"><i class="bi bi-table me-2"></i>Registros de Depósitos</h3>
  <div class="d-flex flex-wrap gap-2">
    <input class="form-control form-control-sm" id="qUsuario" placeholder="Usuario (5 díg.)" style="width: 160px;">
    <select class="form-select form-select-sm" id="qBanco" style="width: 170px;">
      <option value="">Banco (todos)</option>
      <option>BBVA</option><option>Banorte</option><option>Azteca</option><option>Scotiabank</option><option>Santander</option>
    </select>
    <select class="form-select form-select-sm" id="qForma" style="width: 170px;">
      <option value="">Forma (todas)</option>
      <option>Deposito</option><option>Transferencia</option>
    </select>
    <button class="btn btn-outline-secondary btn-sm" id="btnClear"><i class="bi bi-eraser"></i> Limpiar</button>
    <button class="btn btn-outline-success btn-sm" id="btnCSV"><i class="bi bi-filetype-csv"></i> CSV</button>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <div id="grid"></div>
    <div class="text-secondary small mt-2">Doble clic para editar. Enter para guardar. Supr para eliminar fila seleccionada.</div>
  </div>
</div>
{% endblock %}

{% block body_extra %}
<script>
  const grid = new Tabulator("#grid", {
    ajaxURL: "{{ url_for('admin.api_depositos_list') }}",
    height: "70vh",
    layout: "fitColumns",
    reactiveData: true,
    pagination: true,
    paginationSize: 20,
    selectable: 1,
    columns: [
      {title:"ID", field:"id", width:70, hozAlign:"right", headerSort:true, frozen:true},
      {title:"Fecha", field:"fecha_operacion", editor:"input", headerSort:true},
      {title:"Banco", field:"banco", editor:"list", editorParams:{values:["BBVA","Banorte","Azteca","Scotiabank","Santander"]}},
      {title:"Forma", field:"forma_pago", editor:"list", editorParams:{values:["Deposito","Transferencia"]}},
      {title:"Producto", field:"producto", editor:"list", editorParams:{values:["TAE","Pago de servicios"]}},
      {title:"Usuario", field:"numero_usuario", editor:"input"},
      {title:"Importe", field:"importe", editor:"input", hozAlign:"right"},
      {title:"Tipo BBVA", field:"bbva_tipo", editor:"list", editorParams:{values:["","practicaja","caja"]}},
      {title:"Folio", field:"folio", editor:"input"},
      {title:"Autorización", field:"autorizacion", editor:"input"},
      {title:"Referencia", field:"referencia", editor:"input"},
      {title:"Factura", field:"requiere_factura", formatter:"tickCross", hozAlign:"center", editor:true, width:95},
      {title:"Estatus", field:"estatus", editor:"list", editorParams:{values:["registrado","validado","cancelado"]}},
      {title:"Observaciones", field:"observaciones", editor:"input", width:260},
      {title:"Comprobante", field:"comprobante_id", width:140, hozAlign:"center",
        formatter:function(cell){
          const id = cell.getValue(); if(!id) return "—";
          const url = "{{ url_for('admin.comprobante_link', comp_id=0) }}".replace("0", id);
          return `<a class="btn btn-sm btn-outline-primary" target="_blank" href="${url}"><i class="bi bi-file-earmark-arrow-down"></i> Ver</a>`;
        }
      },
    ],
    cellEdited: async (cell)=>{
      const row = cell.getRow().getData();
      const field = cell.getField();
      try{
        await axios.patch(`{{ url_for('admin.api_depositos_update', dep_id=0) }}`.replace("0", row.id), {
          field, value: row[field],
        });
      }catch(err){
        alert("Error al guardar: " + (err.response?.data?.error || err.message));
        grid.replaceData(); // deshacer cambios
      }
    },
  });

  // Filtros
  function applyFilters(){
    const banco = document.getElementById('qBanco').value;
    const forma = document.getElementById('qForma').value;
    const usuario = document.getElementById('qUsuario').value.trim();

    const filters = [];
    if (banco) filters.push({field:"banco", type:"=", value:banco});
    if (forma) filters.push({field:"forma_pago", type:"=", value:forma});
    if (usuario) filters.push({field:"numero_usuario", type:"like", value:usuario});
    grid.setFilter(filters);
  }
  document.getElementById('qBanco').addEventListener('change', applyFilters);
  document.getElementById('qForma').addEventListener('change', applyFilters);
  document.getElementById('qUsuario').addEventListener('input', applyFilters);
  document.getElementById('btnClear').addEventListener('click', ()=>{
    document.getElementById('qBanco').value = "";
    document.getElementById('qForma').value = "";
    document.getElementById('qUsuario').value = "";
    grid.clearFilter();
  });

  // Export CSV
  document.getElementById('btnCSV').addEventListener('click', ()=>{
    grid.download("csv", "depositos.csv");
  });

  // Eliminar con tecla Supr
  document.addEventListener("keydown", async (e)=>{
    if(e.key === "Delete"){
      const rows = grid.getSelectedRows();
      if(rows.length === 1 && confirm("¿Eliminar este registro?")){
        const id = rows[0].getData().id;
        try{
          await axios.delete(`{{ url_for('admin.api_depositos_delete', dep_id=0) }}`.replace("0", id));
          rows[0].delete();
        }catch(err){
          alert("No se pudo eliminar: " + (err.response?.data?.error || err.message));
        }
      }
    }
  });
</script>
{% endblock %}
