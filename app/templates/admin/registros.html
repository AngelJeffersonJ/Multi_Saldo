{% extends "base.html" %}
{% block title %}Registros · Admin · Multisaldo{% endblock %}

{% block head_extra %}
  <!-- Tabulator -->
  <link rel="stylesheet" href="https://unpkg.com/tabulator-tables@6.2.1/dist/css/tabulator.min.css">
  <script defer src="https://unpkg.com/tabulator-tables@6.2.1/dist/js/tabulator.min.js"></script>

  <style>
    /* === Tema claro/oscuro para el interior de la tabla === */
    :root{
      --tbl-bg:#ffffff; --tbl-text:#111;
      --tbl-header:#f8f9fa; --tbl-row:#ffffff; --tbl-row-alt:#f6f6f6;
      --tbl-border:#dee2e6; --tbl-hover:#f1f3f5; --tbl-selected:#cfe2ff;
      --tbl-focus:#0d6efd;
    }
    [data-bs-theme="dark"]{
      --tbl-bg:#0f1620; --tbl-text:#e6edf3;
      --tbl-header:#0b1220; --tbl-row:#0f1620; --tbl-row-alt:#121a26;
      --tbl-border:#223041; --tbl-hover:#1a2535; --tbl-selected:#16324b;
      --tbl-focus:#66b0ff;
    }
    .tabulator{
      background:var(--tbl-bg);
      color:var(--tbl-text);
      border-color:var(--tbl-border);
      border-radius: .5rem;
      overflow: clip;
    }
    .tabulator .tabulator-header{
      background:var(--tbl-header);
      border-bottom:1px solid var(--tbl-border);
    }
    .tabulator .tabulator-col,
    .tabulator .tabulator-cell{
      border-color:var(--tbl-border);
    }
    .tabulator .tabulator-row{
      background:var(--tbl-row);
    }
    .tabulator .tabulator-row.tabulator-row-even{
      background:var(--tbl-row-alt);
    }
    .tabulator .tabulator-row:hover{
      background:var(--tbl-hover);
    }
    .tabulator .tabulator-selected{
      background:var(--tbl-selected) !important;
    }
    .tabulator .tabulator-editing{
      outline:2px solid var(--tbl-focus);
      outline-offset:-2px;
      background:transparent;
    }

    /* Responsive contenedor */
    #gridWrap{
      height: calc(100vh - 270px); /* ocupa el alto restante, ajusta si tu header es más alto */
      min-height: 340px;
    }

    /* Badge “tick” más centrado */
    .tick-center{
      display:flex; align-items:center; justify-content:center;
    }
  </style>
{% endblock %}

{% block content %}
<div class="container-fluid px-0 px-md-2">
  <div class="d-flex align-items-center gap-2 mb-2">
    <i class="bi bi-table fs-3"></i>
    <h2 class="mb-0">Registros de Depósitos</h2>
  </div>

  <div class="alert alert-info py-2">
    Edición estilo Excel: doble clic / F2 para editar, <kbd>Enter</kbd> para guardar,
    <kbd>Supr</kbd> para eliminar. Copiar/pegar y selección múltiple habilitados.
  </div>

  <!-- Barra de filtros -->
  <form id="frmFiltros" class="row g-2 align-items-end mb-3">
    <div class="col-12 col-md-4">
      <label class="form-label">Usuario (5 díg.)</label>
      <input id="fUsuario" class="form-control" placeholder="12345" inputmode="numeric" maxlength="10">
    </div>
    <div class="col-6 col-md-4">
      <label class="form-label">Banco</label>
      <select id="fBanco" class="form-select">
        <option value="">(todos)</option>
        <option>BBVA</option>
        <option>Banorte</option>
        <option>Azteca</option>
        <option>Scotiabank</option>
        <option>Santander</option>
      </select>
    </div>
    <div class="col-6 col-md-4">
      <label class="form-label">Forma</label>
      <select id="fForma" class="form-select">
        <option value="">(todas)</option>
        <option>Deposito</option>
        <option>Transferencia</option>
      </select>
    </div>

    <div class="col-12 d-flex gap-2 mt-1">
      <button id="btnFiltrar" type="submit" class="btn btn-primary">
        <i class="bi bi-funnel"></i> Filtrar
      </button>
      <button id="btnLimpiar" type="button" class="btn btn-outline-secondary">
        <i class="bi bi-eraser"></i> Limpiar
      </button>
      <button id="btnCsv" type="button" class="btn btn-success ms-auto">
        <i class="bi bi-filetype-csv"></i> CSV
      </button>
    </div>
  </form>

  <!-- Grid -->
  <div id="gridWrap">
    <div id="grid"></div>
  </div>
</div>
{% endblock %}

{% block body_extra %}
<script>
(function(){
  // --- utilidades ---
  const toast = (msg, type="danger") => {
    const div = document.createElement("div");
    div.className = `alert alert-${type} position-fixed top-0 start-50 translate-middle-x mt-3 shadow`;
    div.style.zIndex = 1080;
    div.innerHTML = msg;
    document.body.appendChild(div);
    setTimeout(()=>div.remove(), 3500);
  };

  // --- columnas ---
  const columns = [
    {title:"ID", field:"id", width:70, hozAlign:"center", headerSort:true, frozen:true},
    {title:"Fecha", field:"fecha_operacion", editor:"input", sorter:"date", width:130, responsive:0},
    {title:"Banco", field:"banco", editor:"select",
      editorParams:{values:["BBVA","Banorte","Azteca","Scotiabank","Santander"]},
      width:140
    },
    {title:"Forma", field:"forma_pago", editor:"select",
      editorParams:{values:["Deposito","Transferencia"]},
      width:150
    },
    {title:"Producto", field:"producto", editor:"select",
      editorParams:{values:["TAE","Pago de servicios"]},
      width:180, responsive:0
    },
    {title:"Usuario", field:"numero_usuario", editor:"input", validator:"integer",
      width:120, hozAlign:"center"
    },
    {title:"Importe", field:"importe", editor:"input",
      formatter:"money", formatterParams:{symbol:"$", thousand:",", decimal:".", precision:2},
      width:120, hozAlign:"right"
    },
    {title:"BBVA tipo", field:"bbva_tipo", editor:"select",
      editorParams:{values:["","practicaja","caja"]}, width:130
    },
    {title:"Folio", field:"folio", editor:"input", width:120},
    {title:"Autor.", field:"autorizacion", editor:"input", width:120},
    {title:"Refer.", field:"referencia", editor:"input", width:150},
    {title:"Factura", field:"requiere_factura", editor:true, formatter:"tickCross",
      hozAlign:"center", width:100, cssClass:"tick-center"
    },
    {title:"Estatus", field:"estatus", editor:"input", width:130},
    {title:"Obs.", field:"observaciones", editor:"textarea", width:260, responsive:2},
    {title:"Comprobante", field:"comprobante_id", headerSort:false, width:150, hozAlign:"center",
      formatter:function(cell){
        const id = cell.getValue();
        if(!id) return "";
        const a = document.createElement("a");
        a.className = "btn btn-sm btn-outline-primary";
        a.href = `/admin/comprobante/${id}/link`;
        a.target = "_blank";
        a.textContent = "Comprobante";
        return a;
      }
    },
  ];

  // --- instancia Tabulator ---
  const table = new Tabulator("#grid", {
    columns,
    data: [],                // se llenará con cargar()
    index: "id",
    layout: "fitDataStretch",
    responsiveLayout: "collapse",
    selectable: 1,
    reactiveData: false,
    clipboard: true,
    clipboardPasteAction:"update",
    height: "100%",          // ocupa 100% de #gridWrap
    placeholder: "Sin datos con los filtros actuales.",
    headerSortElement: "<i class='bi bi-caret-down'></i>",
  });

  // Al editar → PATCH al backend
  table.on("cellEdited", async (cell) => {
    const row = cell.getRow();
    const id = row.getData().id;
    const field = cell.getField();
    let value = cell.getValue();

    // normalizaciones mínimas
    if(field === "numero_usuario" && value !== null){
      value = String(value).replace(/\D/g,"");
    }
    if(field === "importe" && value !== null){
      value = String(value).replace(/[^0-9.]/g,"");
    }

    try{
      const resp = await fetch(`/admin/api/depositos/${id}`,{
        method:"PATCH",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({field, value})
      });
      if(!resp.ok){
        const e = await resp.json().catch(()=>({error:resp.statusText}));
        throw new Error(e.error || "No se pudo guardar");
      }
      // ok
    }catch(err){
      toast(err.message || "No se pudo guardar", "danger");
      row.reformat(); // refresca valores
      // vuelve a pedir datos de esa fila desde el backend si prefieres
    }
  });

  // Supr → eliminar fila seleccionada
  document.addEventListener("keydown", async (ev)=>{
    if(ev.key !== "Delete") return;
    const row = table.getSelectedRows()[0];
    if(!row) return;
    const id = row.getData().id;
    if(!confirm(`¿Eliminar registro #${id}?`)) return;
    try{
      const resp = await fetch(`/admin/api/depositos/${id}`,{ method:"DELETE" });
      if(!resp.ok){
        const e = await resp.json().catch(()=>({error:resp.statusText}));
        throw new Error(e.error || "No se pudo eliminar");
      }
      row.delete();
      toast("Eliminado.", "success");
    }catch(err){
      toast(err.message || "No se pudo eliminar");
    }
  });

  // CSV
  document.getElementById("btnCsv").addEventListener("click", ()=>{
    table.download("csv", `depositos_${new Date().toISOString().slice(0,10)}.csv`);
  });

  // --- Filtros ---
  async function cargar(){
    const usuario = (document.getElementById('fUsuario').value || "").replace(/\D/g,"");
    const banco   = document.getElementById('fBanco').value || "";
    const forma   = document.getElementById('fForma').value || "";

    const q = new URLSearchParams();
    if(usuario) q.set("numero_usuario", usuario);
    if(banco)   q.set("banco", banco);
    if(forma)   q.set("forma_pago", forma);

    try{
      const resp = await fetch(`/admin/api/depositos?${q.toString()}`);
      if(!resp.ok){
        const e = await resp.json().catch(()=>({error:resp.statusText}));
        throw new Error(e.error || `GET ${resp.status}`);
      }
      const data = await resp.json();
      table.setData(data);
    }catch(err){
      table.clearData();
      toast(`No se pudo cargar: ${err.message}`);
    }
  }

  // submit filtros
  document.getElementById("frmFiltros").addEventListener("submit", (e)=>{
    e.preventDefault();
    cargar();
  });

  // limpiar
  document.getElementById("btnLimpiar").addEventListener("click", ()=>{
    document.getElementById('fUsuario').value = "";
    document.getElementById('fBanco').value   = "";
    document.getElementById('fForma').value   = "";
    cargar();
  });

  // resize → recalcular alto del grid si cambia el header
  const wrap = document.getElementById("gridWrap");
  const ro = new ResizeObserver(()=> table.redraw(true));
  ro.observe(wrap);

  // carga inicial
  cargar();
})();
</script>
{% endblock %}
