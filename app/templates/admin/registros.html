{% extends "base.html" %}
{% block title %}Registros · Multisaldo{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-xl-11">
    <div class="card shadow-sm">
      <div class="card-body p-4">

        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
          <div class="d-flex align-items-center gap-2">
            <h3 class="mb-0"><i class="bi bi-table me-2"></i>Registros de Depósitos</h3>
            <span id="status" class="text-secondary small">Listo.</span>
          </div>
          <div class="d-flex gap-2">
            <button id="btn-add" class="btn btn-primary btn-sm"><i class="bi bi-plus-lg"></i> Agregar</button>
            <button id="btn-del" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash"></i> Eliminar</button>
            <button id="btn-csv" class="btn btn-success btn-sm"><i class="bi bi-filetype-csv"></i> CSV</button>
          </div>
        </div>

        <!-- Filtros rápidos -->
        <div class="row g-2 align-items-center mb-3">
          <div class="col-12 col-md-auto">
            <input id="q-usuario" class="form-control form-control-sm" placeholder="Usuario (5 díg.)" maxlength="5" pattern="\d{5}">
          </div>
          <div class="col-12 col-md-auto">
            <select id="q-banco" class="form-select form-select-sm">
              <option value="">Banco (todos)</option>
              <option>BBVA</option><option>Banorte</option><option>Azteca</option>
              <option>Scotiabank</option><option>Santander</option>
            </select>
          </div>
          <div class="col-12 col-md-auto">
            <select id="q-forma" class="form-select form-select-sm">
              <option value="">Forma (todas)</option>
              <option>Deposito</option><option>Transferencia</option>
            </select>
          </div>
          <div class="col-12 col-md-auto">
            <button id="btn-clear" class="btn btn-outline-secondary btn-sm">
              <i class="bi bi-eraser"></i> Limpiar
            </button>
          </div>
        </div>

        <div id="grid"></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal preview comprobante -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-eye me-2"></i>Comprobante</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-0" style="height:75vh;">
        <iframe id="previewFrame" style="width:100%;height:100%;border:0;"></iframe>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block body_extra %}
<link rel="stylesheet" href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css">
<script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>

<style>
  /* Tabulator con variables de Bootstrap (se adapta a claro/oscuro) */
  :root {
    --grid-bg: var(--bs-body-bg);
    --grid-fg: var(--bs-body-color);
    --grid-border: var(--bs-border-color);
    --grid-row-selected: color-mix(in oklab, var(--bs-primary) 15%, transparent);
    --grid-header-bg: var(--bs-body-bg);
  }
  .tabulator{
    background:var(--grid-bg);
    color:var(--grid-fg);
    border:1px solid var(--grid-border);
    border-radius:.5rem;
  }
  .tabulator .tabulator-header{background:var(--grid-header-bg); border-bottom:1px solid var(--grid-border);}
  .tabulator .tabulator-col, .tabulator .tabulator-cell{border-right:1px solid var(--grid-border);}
  .tabulator-row{background:var(--grid-bg);}
  .tabulator-row.tabulator-selected{background:var(--grid-row-selected);}
  .tabulator .tabulator-header .tabulator-col .tabulator-header-filter input,
  .tabulator .tabulator-header .tabulator-col .tabulator-header-filter select{
    background:var(--grid-bg); color:var(--grid-fg);
    border:1px solid var(--grid-border); border-radius:.375rem; padding:.2rem .35rem;
  }
  .btn-icon { padding:.25rem .5rem; }
</style>

<script>
(function(){
  const API_LIST   = "{{ url_for('admin.api_depositos_list') }}";                // GET
  const API_CREATE = "{{ url_for('admin.api_depositos_create') }}";              // POST
  const API_UPD    = "{{ url_for('admin.api_depositos_update', dep_id=0) }}";    // PATCH (reemplazar 0)
  const API_DEL    = "{{ url_for('admin.api_depositos_delete', dep_id=0) }}";    // DELETE (reemplazar 0)
  const LINK_COMP  = "{{ url_for('admin.comprobante_link', comp_id=0) }}";       // GET (redirect)

  const statusEl = document.getElementById('status');
  const setStatus = (t)=>{ statusEl.textContent = t; };

  // Preview comprobante (iframe para JPG/PNG/PDF)
  const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
  const previewFrame = document.getElementById('previewFrame');
  function openPreview(compId){
    if(!compId) return;
    previewFrame.src = LINK_COMP.replace("0", compId);
    previewModal.show();
  }

  // Columnas
  function accionesFormatter(cell){
    const d = cell.getRow().getData();
    const compId = d.comprobante_id;
    const previewBtn = compId
      ? `<button class="btn btn-outline-primary btn-icon me-1" data-action="preview" title="Ver"><i class="bi bi-eye"></i></button>`
      : '';
    const openBtn = compId
      ? `<a class="btn btn-outline-secondary btn-icon me-1" target="_blank" href="${LINK_COMP.replace('0', compId)}" title="Abrir"><i class="bi bi-box-arrow-up-right"></i></a>`
      : '';
    const editBtn = `<button class="btn btn-outline-warning btn-icon" data-action="edit" title="Editar"><i class="bi bi-pencil-square"></i></button>`;
    return previewBtn + openBtn + editBtn;
  }

  async function saveCell(cell){
    const row = cell.getRow(), id = row.getData().id;
    const payload = { field: cell.getField(), value: cell.getValue() };

    setStatus("Guardando…");
    try{
      const r = await fetch(API_UPD.replace("0", id), {
        method:"PATCH", headers:{ "Content-Type":"application/json" }, credentials:"same-origin",
        body: JSON.stringify(payload)
      });
      if(!r.ok) throw new Error(await r.text());
      setStatus("Guardado.");
    }catch(e){
      console.error(e); setStatus("Error al guardar."); cell.restoreOldValue();
      alert("No se pudo guardar: " + e.message);
    }
  }

  async function deleteSelected(){
    const row = grid.getSelectedRows()[0];
    if(!row) return alert("Selecciona una fila.");
    const id = row.getData().id;
    if(!confirm(`Eliminar depósito #${id}?`)) return;

    setStatus("Eliminando…");
    try{
      const r = await fetch(API_DEL.replace("0", id), {method:"DELETE", credentials:"same-origin"});
      if(!r.ok) throw new Error(await r.text());
      row.delete();
      setStatus("Eliminado.");
    }catch(e){
      console.error(e); setStatus("Error al eliminar."); alert("No se pudo eliminar: " + e.message);
    }
  }

  async function createRow(initial){
    setStatus("Creando…");
    try{
      const r = await fetch(API_CREATE, {
        method:"POST", headers:{ "Content-Type":"application/json" }, credentials:"same-origin",
        body: JSON.stringify(initial||{})
      });
      if(!r.ok) throw new Error(await r.text());
      const data = await r.json();
      grid.addData([data], true);      // prepend
      setStatus("Creado. Doble-clic para editar.");
    }catch(e){
      console.error(e); setStatus("Error al crear."); alert("No se pudo crear: " + e.message);
    }
  }

  const cols = [
    {title:"ID", field:"id", width:70, hozAlign:"right"},
    {title:"Fecha", field:"fecha_operacion", headerFilter:"input", editor:"input", width:130},
    {title:"Banco", field:"banco", headerFilter:"select", headerFilterParams:{values:true},
      editor:"select", editorParams:{values:["BBVA","Banorte","Azteca","Scotiabank","Santander"]}, width:140},
    {title:"Forma", field:"forma_pago", headerFilter:"select",
      editor:"select", editorParams:{values:["Deposito","Transferencia"]}, width:140},
    {title:"Producto", field:"producto", headerFilter:"select",
      editor:"select", editorParams:{values:["TAE","Pago de servicios"]}, width:180},
    {title:"Usuario", field:"numero_usuario", headerFilter:"input", editor:"input", width:120},
    {title:"Importe", field:"importe", headerFilter:"input", editor:"input", hozAlign:"right", width:110},
    {title:"BBVA tipo", field:"bbva_tipo", headerFilter:"select",
      editor:"select", editorParams:{values:["","practicaja","caja"]}, width:130},
    {title:"Folio", field:"folio", headerFilter:"input", editor:"input", width:120},
    {title:"Autorización", field:"autorizacion", headerFilter:"input", editor:"input", width:140},
    {title:"Referencia", field:"referencia", headerFilter:"input", editor:"input", width:140},
    {title:"Factura", field:"requiere_factura", headerFilter:"select",
      headerFilterParams:{values:{"":"(todas)","true":"Sí","false":"No"}},
      formatter:"tickCross", hozAlign:"center", width:90, editor:true, mutatorEdit:(v)=>!!v},
    {title:"Estatus", field:"estatus", headerFilter:"input", editor:"input", width:120},
    {title:"Obs.", field:"observaciones", headerFilter:"input", editor:"textarea", width:220},
    {title:"Acciones", field:"_a", width:210, headerSort:false, hozAlign:"center", formatter:accionesFormatter},
  ];

  // Grid
  const grid = new Tabulator("#grid", {
    ajaxURL: API_LIST,
    ajaxConfig:{method:"GET", credentials:"same-origin"},
    layout:"fitDataStretch",
    height:"70vh",
    columns: cols,
    selectable:1,
    clipboard:true,
    clipboardPasteAction:"update",
    history:true,
    persistence:{sort:true, filter:true, columns:true},
    placeholder:"Sin registros.",
    ajaxResponse:(u,p,data)=>{ setStatus(`Filas: ${data.length}`); return data; },
    ajaxError:()=>{ setStatus("Error al cargar."); },
    cellEdited: saveCell,
    keybindings:{ "delete": deleteSelected },
    rowFormatter:function(row){
      row.getElement().addEventListener('click', (ev)=>{
        const btn = ev.target.closest('button, a');
        if(!btn) return;
        const action = btn.dataset.action;
        const data = row.getData();
        if(action === 'preview') openPreview(data.comprobante_id);
        if(action === 'edit'){
          const c = row.getCells().find(c=>c.getColumn().getDefinition().editor);
          if(c) c.edit();
        }
      });
    }
  });

  // Filtros rápidos (client-side usando header filters)
  const qUsuario = document.getElementById('q-usuario');
  const qBanco   = document.getElementById('q-banco');
  const qForma   = document.getElementById('q-forma');
  const syncQuick = ()=>{
    grid.setHeaderFilterValue("numero_usuario", qUsuario.value||"");
    grid.setHeaderFilterValue("banco", qBanco.value||"");
    grid.setHeaderFilterValue("forma_pago", qForma.value||"");
  };
  qUsuario.addEventListener('input', syncQuick);
  qBanco.addEventListener('change', syncQuick);
  qForma.addEventListener('change', syncQuick);
  document.getElementById('btn-clear').addEventListener('click', ()=>{
    qUsuario.value=""; qBanco.value=""; qForma.value=""; grid.clearHeaderFilter();
  });

  // Acciones barra
  document.getElementById('btn-csv').addEventListener('click', ()=> grid.download("csv","depositos.csv"));
  document.getElementById('btn-del').addEventListener('click', deleteSelected);
  document.getElementById('btn-add').addEventListener('click', ()=>{
    // Crea registro mínimo; el backend completará defaults
    createRow({ banco:"BBVA", forma_pago:"Deposito", producto:"TAE", estatus:"registrado" });
  });

  // Sincronizar tema (por si cambias claro/oscuro en la barra)
  const obs = new MutationObserver(()=>{ grid.redraw(true); });
  obs.observe(document.documentElement, {attributes:true, attributeFilter:["data-bs-theme"]});
})();
</script>
{% endblock %}
