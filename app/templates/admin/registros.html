{% extends "base.html" %}
{% block title %}Registros · Admin · Multisaldo{% endblock %}

{% block content %}
<div class="container-xxl">
  <div class="d-flex align-items-center mb-3">
    <h3 class="me-3 mb-0"><i class="bi bi-table me-2"></i>Registros de Depósitos</h3>
    <span class="text-secondary small">Doble clic para editar. <kbd>Enter</kbd> para guardar. <kbd>Supr</kbd> para eliminar fila seleccionada.</span>
  </div>

  <!-- Mensajes -->
  <div id="alertBox" class="alert alert-danger d-none" role="alert"></div>

  <!-- Filtros -->
  <div class="row g-2 align-items-end mb-3">
    <div class="col-sm-4 col-md-3 col-lg-3">
      <label class="form-label">Usuario (5 díg.)</label>
      <input id="fUsuario" class="form-control" placeholder="12345" inputmode="numeric" pattern="\d{5}">
    </div>
    <div class="col-sm-4 col-md-3 col-lg-3">
      <label class="form-label">Banco</label>
      <select id="fBanco" class="form-select">
        <option value="">(todos)</option>
        <option>BBVA</option><option>Banorte</option><option>Azteca</option>
        <option>Scotiabank</option><option>Santander</option>
      </select>
    </div>
    <div class="col-sm-4 col-md-3 col-lg-3">
      <label class="form-label">Forma</label>
      <select id="fForma" class="form-select">
        <option value="">(todas)</option>
        <option>Deposito</option>
        <option>Transferencia</option>
      </select>
    </div>
    <div class="col-sm-12 col-md-3 col-lg-3 d-flex gap-2">
      <button id="btnFiltrar" class="btn btn-primary flex-grow-1"><i class="bi bi-funnel me-1"></i>Filtrar</button>
      <button id="btnLimpiar" class="btn btn-outline-secondary"><i class="bi bi-eraser me-1"></i>Limpiar</button>
      <button id="btnCSV" class="btn btn-success"><i class="bi bi-filetype-csv me-1"></i>CSV</button>
    </div>
  </div>

  <!-- Grid -->
  <div class="card shadow-sm">
    <div class="card-body">
      <div id="grid" class="table-responsive"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block head_extra %}
<!-- Tabulator (CSS/JS desde CDN) -->
<link href="https://unpkg.com/tabulator-tables@6.3.0/dist/css/tabulator.min.css" rel="stylesheet">
<script src="https://unpkg.com/tabulator-tables@6.3.0/dist/js/tabulator.min.js"></script>

<style>
  /* Integración con Bootstrap: colores según tema */
  :root[data-bs-theme="light"] .tabulator,
  :root[data-bs-theme="light"] .tabulator .tabulator-header,
  :root[data-bs-theme="light"] .tabulator .tabulator-table {
    background-color: var(--bs-body-bg);
    color: var(--bs-body-color);
  }
  :root[data-bs-theme="light"] .tabulator .tabulator-header {
    border-bottom: 1px solid var(--bs-border-color);
  }
  :root[data-bs-theme="light"] .tabulator .tabulator-row {
    border-color: var(--bs-border-color);
  }

  :root[data-bs-theme="dark"] .tabulator,
  :root[data-bs-theme="dark"] .tabulator .tabulator-header,
  :root[data-bs-theme="dark"] .tabulator .tabulator-table {
    background-color: var(--bs-dark);
    color: var(--bs-light);
  }
  :root[data-bs-theme="dark"] .tabulator .tabulator-header {
    border-bottom: 1px solid rgba(255,255,255,.15);
  }
  :root[data-bs-theme="dark"] .tabulator .tabulator-row {
    border-color: rgba(255,255,255,.1);
  }

  .tabulator .btn-link-like {
    padding: .25rem .5rem;
    border-radius: .5rem;
  }
</style>
{% endblock %}

{% block body_extra %}
<script>
(() => {
  const $alert = document.getElementById('alertBox');
  function showError(msg) {
    $alert.textContent = msg;
    $alert.classList.remove('d-none');
    setTimeout(() => $alert.classList.add('d-none'), 5000);
  }

  // ------ Grid (Tabulator) ------
  const grid = new Tabulator("#grid", {
    height: "65vh",
    layout: "fitDataStretch",
    reactiveData: false,
    placeholder: "Sin datos",
    index: "id",
    columns: [
      { title:"ID", field:"id", hozAlign:"center", width:70, headerSort:true },
      { title:"Fecha", field:"fecha_operacion", editor:"input", headerSort:true, width:130, validator:["required"] },
      { title:"Banco", field:"banco", editor:"list", editorParams:{values:["BBVA","Banorte","Azteca","Scotiabank","Santander"]}, width:140 },
      { title:"Forma", field:"forma_pago", editor:"list", editorParams:{values:["Deposito","Transferencia"]}, width:140 },
      { title:"Producto", field:"producto", editor:"list", editorParams:{values:["TAE","Pago de servicios"]}, width:180 },
      { title:"Usuario", field:"numero_usuario", editor:"input", width:120, hozAlign:"center" },
      { title:"Importe", field:"importe", editor:"input", width:110, formatter:(cell)=> {
          const v = cell.getValue(); return v ? Number(v).toFixed(2):"0.00";
      }, hozAlign:"right" },
      { title:"BBVA tipo", field:"bbva_tipo", editor:"list",
        editorParams:{values:["","practicaja","caja"]}, width:120 },
      { title:"Folio", field:"folio", editor:"input", width:130 },
      { title:"Autor.", field:"autorizacion", editor:"input", width:120 },
      { title:"Ref.", field:"referencia", editor:"input", width:150 },
      { title:"Factura", field:"requiere_factura", width:90, hozAlign:"center",
        formatter:"tickCross", editor:true },
      { title:"Estatus", field:"estatus", editor:"input", width:140 },
      { title:"Obs.", field:"observaciones", editor:"textarea", width:250 },
      { title:"Comprobante", field:"comprobante_id", headerSort:false, hozAlign:"center", width:140,
        formatter:(cell)=>{
          const id = cell.getValue();
          if (!id) return "-";
          return `<a href="/admin/comprobante/${id}/link" target="_blank" class="btn btn-sm btn-outline-primary btn-link-like"><i class="bi bi-paperclip"></i> Abrir</a>`;
        }
      },
    ],
    cellEdited: async (cell) => {
      const row = cell.getRow().getData();
      const field = cell.getField();
      let value = cell.getValue();

      // normaliza boolean del tickCross
      if (field === "requiere_factura") value = !!value;

      try {
        const res = await fetch(`/admin/api/depositos/${row.id}`, {
          method: "PATCH",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ field, value })
        });
        if (!res.ok) {
          const j = await res.json().catch(()=>({error:res.statusText}));
          throw new Error(j.error || "Error guardando");
        }
        const updated = await res.json();
        cell.getRow().update(updated); // sincroniza con backend
      } catch (e) {
        showError("No se pudo guardar: " + e.message);
        cell.restoreOldValue(); // deshacer en UI
      }
    },
    rowDeselected: ()=>{}, // placeholder
  });

  // DELETE con Supr
  document.addEventListener("keydown", async (ev) => {
    if (ev.key !== "Delete") return;
    const rows = grid.getSelectedRows();
    if (!rows.length) return;
    const id = rows[0].getData().id;
    if (!confirm(`¿Eliminar registro #${id}?`)) return;
    try {
      const res = await fetch(`/admin/api/depositos/${id}`, { method: "DELETE" });
      if (!res.ok) throw new Error("No se pudo eliminar");
      rows[0].delete();
    } catch (e) {
      showError(e.message);
    }
  });

  // ------ Filtros ------
  async function cargar() {
    const p = new URLSearchParams();
    const u = document.getElementById('fUsuario').value.trim();
    const b = document.getElementById('fBanco').value;
    const f = document.getElementById('fForma').value;
    if (u) p.set("numero_usuario", u);
    if (b) p.set("banco", b);
    if (f) p.set("forma_pago", f);

    try {
      const res = await fetch(`/admin/api/depositos?${p.toString()}`);
      const data = await res.json();
      grid.setData(data);
    } catch (e) {
      showError("No se pudo cargar: " + e.message);
    }
  }
  document.getElementById('btnFiltrar').addEventListener('click', cargar);
  document.getElementById('btnLimpiar').addEventListener('click', () => {
    document.getElementById('fUsuario').value = "";
    document.getElementById('fBanco').value = "";
    document.getElementById('fForma').value = "";
    cargar();
  });
  document.getElementById('btnCSV').addEventListener('click', () => {
    grid.download("csv", `depositos_${new Date().toISOString().slice(0,10)}.csv`);
  });

  // carga inicial
  cargar();

  // Si el usuario cambia el tema (si tienes un toggle), refrescamos estilos de Tabulator
  const obs = new MutationObserver(() => grid.redraw(true));
  obs.observe(document.documentElement, { attributes:true, attributeFilter:["data-bs-theme"] });
})();
</script>
{% endblock %}
