{% extends "base.html" %}
{% block title %}Registros · Admin · Multisaldo{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-quartz.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-quartz-dark.css">
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.noStyle.js"></script>
<style>
  /* Altura y pequeños ajustes */
  #grid { height: 72vh; }
  .btn-link-like{ padding:.25rem .5rem; border-radius:.5rem; }
</style>
{% endblock %}

{% block content %}
<div class="container-xxl">
  <div class="d-flex align-items-center mb-3">
    <h3 class="me-3 mb-0"><i class="bi bi-table me-2"></i>Registros de Depósitos</h3>
    <span class="text-secondary small">Doble clic/F2 para editar, <kbd>Enter</kbd> para guardar, <kbd>Supr</kbd> para eliminar. Copiar/pegar funciona como Excel.</span>
  </div>

  <div id="alertBox" class="alert alert-danger d-none" role="alert"></div>

  <!-- Filtros -->
  <div class="row g-2 align-items-end mb-3">
    <div class="col-sm-4 col-md-3">
      <label class="form-label">Usuario (5 díg.)</label>
      <input id="fUsuario" class="form-control" placeholder="12345" inputmode="numeric" pattern="\d{5}">
    </div>
    <div class="col-sm-4 col-md-3">
      <label class="form-label">Banco</label>
      <select id="fBanco" class="form-select">
        <option value="">(todos)</option>
        <option>BBVA</option><option>Banorte</option><option>Azteca</option>
        <option>Scotiabank</option><option>Santander</option>
      </select>
    </div>
    <div class="col-sm-4 col-md-3">
      <label class="form-label">Forma</label>
      <select id="fForma" class="form-select">
        <option value="">(todas)</option>
        <option>Deposito</option><option>Transferencia</option>
      </select>
    </div>
    <div class="col-sm-12 col-md-3 d-flex gap-2">
      <button id="btnFiltrar" class="btn btn-primary flex-grow-1"><i class="bi bi-funnel me-1"></i>Filtrar</button>
      <button id="btnLimpiar" class="btn btn-outline-secondary"><i class="bi bi-eraser me-1"></i>Limpiar</button>
      <button id="btnCSV" class="btn btn-success"><i class="bi bi-filetype-csv me-1"></i>CSV</button>
    </div>
  </div>

  <div id="grid" class="ag-theme-quartz"></div>
</div>
{% endblock %}

{% block body_extra %}
<script>
(() => {
  // ---- helpers UI
  const $alert = document.getElementById('alertBox');
  function showError(msg){
    console.error(msg);
    $alert.textContent = typeof msg === 'string' ? msg : (msg?.message || 'Error');
    $alert.classList.remove('d-none');
    setTimeout(()=> $alert.classList.add('d-none'), 6000);
  }

  // ---- tema claro/oscuro de AG Grid
  const gridDiv = document.getElementById('grid');
  function applyTheme(){
    gridDiv.classList.remove('ag-theme-quartz','ag-theme-quartz-dark');
    const dark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
    gridDiv.classList.add(dark ? 'ag-theme-quartz-dark' : 'ag-theme-quartz');
  }
  applyTheme();
  new MutationObserver(applyTheme).observe(document.documentElement, {attributes:true, attributeFilter:['data-bs-theme']});

  // ---- definición de columnas
  const columnDefs = [
    { headerName:"ID", field:"id", width:90, sortable:true, resizable:true },
    { headerName:"Fecha", field:"fecha_operacion", editable:true, width:140 },
    { headerName:"Banco", field:"banco", editable:true, width:140,
      cellEditor:'agSelectCellEditor',
      cellEditorParams:{ values:["BBVA","Banorte","Azteca","Scotiabank","Santander"] }
    },
    { headerName:"Forma", field:"forma_pago", editable:true, width:150,
      cellEditor:'agSelectCellEditor',
      cellEditorParams:{ values:["Deposito","Transferencia"] }
    },
    { headerName:"Producto", field:"producto", editable:true, width:190,
      cellEditor:'agSelectCellEditor',
      cellEditorParams:{ values:["TAE","Pago de servicios"] }
    },
    { headerName:"Usuario", field:"numero_usuario", editable:true, width:130,
      valueSetter:(p)=>{ p.data.numero_usuario = p.newValue? parseInt(p.newValue,10) || 0 : 0; return true;}
    },
    { headerName:"Importe", field:"importe", editable:true, width:120,
      valueFormatter:(p)=> p.value ? Number(p.value).toFixed(2) : "0.00",
      valueSetter:(p)=>{ p.data.importe = p.newValue; return true; }
    },
    { headerName:"BBVA tipo", field:"bbva_tipo", editable:true, width:130,
      cellEditor:'agSelectCellEditor',
      cellEditorParams:{ values:["","practicaja","caja"] }
    },
    { headerName:"Folio", field:"folio", editable:true, width:140 },
    { headerName:"Autor.", field:"autorizacion", editable:true, width:120 },
    { headerName:"Ref.", field:"referencia", editable:true, width:160 },
    { headerName:"Factura", field:"requiere_factura", width:110,
      editable:true, cellRenderer:'agCheckboxCellRenderer',
      valueSetter:(p)=>{ p.data.requiere_factura = (!!p.newValue); return true; }
    },
    { headerName:"Estatus", field:"estatus", editable:true, width:140 },
    { headerName:"Obs.", field:"observaciones", editable:true, minWidth:240, flex:1 },
    { headerName:"Comprobante", field:"comprobante_id", width:150,
      editable:false, sortable:false,
      cellRenderer:(p)=>{
        const id = p.value;
        return id ? `<a href="/admin/comprobante/${id}/link" target="_blank" class="btn btn-sm btn-outline-primary btn-link-like"><i class="bi bi-paperclip"></i> Abrir</a>` : "-";
      }
    },
  ];

  // ---- grid options
  let gridApi;
  const gridOptions = {
    columnDefs,
    rowData: [],
    rowSelection: 'single',
    animateRows: true,
    defaultColDef: { resizable:true, sortable:true, filter:true },
    enableRangeSelection: true,
    enableFillHandle: true,
    undoRedoCellEditing: true,
    suppressClickEdit: false,       // doble clic o F2 también funciona
    onCellValueChanged: onCellValueChanged,
    onGridReady: () => { gridApi.sizeColumnsToFit(); },
  };

  // inicializa
  gridApi = agGrid.createGrid(gridDiv, gridOptions);

  // ---- carga datos (filtros contra backend)
  async function cargar(){
    const u = document.getElementById('fUsuario').value.trim();
    const b = document.getElementById('fBanco').value;
    const f = document.getElementById('fForma').value;
    const q = new URLSearchParams();
    if (u) q.set('numero_usuario', u);
    if (b) q.set('banco', b);
    if (f) q.set('forma_pago', f);

    try{
      const res = await fetch(`/admin/api/depositos?${q.toString()}`, {credentials:'same-origin'});
      if(!res.ok) throw new Error(`GET ${res.status}`);
      const data = await res.json();
      gridApi.setGridOption('rowData', data);
      gridApi.sizeColumnsToFit();
    }catch(e){ showError('No se pudo cargar: '+e.message); }
  }

  document.getElementById('btnFiltrar').addEventListener('click', cargar);
  document.getElementById('btnLimpiar').addEventListener('click', ()=> {
    document.getElementById('fUsuario').value = '';
    document.getElementById('fBanco').value = '';
    document.getElementById('fForma').value = '';
    cargar();
  });
  document.getElementById('btnCSV').addEventListener('click', ()=> {
    gridApi.exportDataAsCsv({ fileName:`depositos_${new Date().toISOString().slice(0,10)}.csv` });
  });

  // ---- edita => PATCH
  async function onCellValueChanged(ev){
    // si no hay cambio real, nada
    if (ev.newValue === ev.oldValue) return;

    const id = ev.data.id;
    const field = ev.colDef.field;
    let value = ev.newValue;

    // normaliza tipos
    if (field === 'numero_usuario') value = parseInt(value,10) || 0;
    if (field === 'requiere_factura') value = !!value;

    try{
      const res = await fetch(`/admin/api/depositos/${id}`, {
        method:'PATCH',
        headers:{'Content-Type':'application/json'},
        credentials:'same-origin',
        body: JSON.stringify({field, value})
      });
      if(!res.ok){
        const txt = await res.text();
        throw new Error(`PATCH ${res.status}: ${txt}`);
      }
      // si tu backend devuelve el objeto actualizado, podrías:
      // const updated = await res.json(); ev.node.setData(updated);
    }catch(e){
      showError('No se pudo guardar: '+e.message);
      // revertir visualmente
      ev.node.setDataValue(field, ev.oldValue);
    }
  }

  // ---- borrar con Supr (DELETE)
  document.addEventListener('keydown', async (e) => {
    if (e.key !== 'Delete') return;
    const sel = gridApi.getSelectedNodes();
    if (!sel.length) return;
    const row = sel[0].data;
    if (!confirm(`¿Eliminar el registro #${row.id}?`)) return;

    try{
      const res = await fetch(`/admin/api/depositos/${row.id}`, {
        method:'DELETE', credentials:'same-origin'
      });
      if(!res.ok && res.status !== 204){
        const txt = await res.text();
        throw new Error(`DELETE ${res.status}: ${txt}`);
      }
      gridApi.applyTransaction({ remove:[row] });
    }catch(e){ showError('No se pudo eliminar: '+e.message); }
  });

  // primera carga
  cargar();
})();
</script>
{% endblock %}
