<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registros de Depósitos</title>

  <!-- Tabulator -->
  <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
  <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#111;color:#e5e7eb}
    .bar{display:flex;align-items:center;gap:.5rem;padding:1rem;border-bottom:1px solid #333}
    .wrap{padding:1.25rem}
    .btn{padding:.5rem .75rem;border-radius:.5rem;border:1px solid #444;background:#1f2937;color:#e5e7eb;cursor:pointer}
    .btn:hover{background:#374151}
    .input,.select{background:#111;border:1px solid #444;color:#e5e7eb;border-radius:.5rem;padding:.45rem .6rem}
    .title{display:flex;align-items:center;gap:.5rem;font-size:1.8rem;font-weight:700;margin:.75rem 0 1rem}
    .hint{background:#0f172a;border:1px solid #334155;border-radius:.75rem;padding:.75rem 1rem;color:#9ca3af}
  </style>
</head>
<body>

  <div class="bar">
    <strong style="font-size:1.2rem">Multisaldo</strong>
    <div style="flex:1"></div>
    <a class="btn" href="{{ url_for('public.registro') }}">Registro</a>
    <a class="btn" href="{{ url_for('admin.logout') }}">Salir</a>
  </div>

  <div class="wrap">
    <div class="title">📊 Registros de Depósitos</div>

    <div class="hint">
      Doble clic para editar. Enter para guardar. Supr para eliminar fila seleccionada.
    </div>

    <div style="display:flex;gap:.5rem;margin:1rem 0;flex-wrap:wrap">
      <input id="f-usuario" class="input" placeholder="Usuario (5 díg.)" maxlength="5" pattern="\\d{5}">
      <select id="f-banco" class="select">
        <option value="">Banco (todos)</option>
        <option>BBVA</option><option>Banorte</option><option>Azteca</option><option>Scotiabank</option><option>Santander</option>
      </select>
      <select id="f-forma" class="select">
        <option value="">Forma (todas)</option>
        <option>Deposito</option><option>Transferencia</option>
      </select>
      <button id="btn-filtrar" class="btn">Filtrar</button>
      <button id="btn-limpiar" class="btn">Limpiar</button>
      <button id="btn-csv" class="btn">CSV</button>
    </div>

    <div id="grid"></div>
  </div>

<script>
  // Construye URL de la API con parámetros de filtro
  function buildApiUrl(){
    const base = "{{ url_for('admin.api_depositos_list') }}";
    const p = new URLSearchParams();
    const u = document.getElementById('f-usuario').value.trim();
    const b = document.getElementById('f-banco').value;
    const f = document.getElementById('f-forma').value;
    if (u) p.set('numero_usuario', u);
    if (b) p.set('banco', b);
    if (f) p.set('forma_pago', f);
    const qs = p.toString();
    return qs ? (base + "?" + qs) : base;
  }

  // Columna con link a comprobante
  function comprobanteFormatter(cell){
    const id = cell.getValue();
    if(!id) return "";
    const url = "{{ url_for('admin.comprobante_link', comp_id=0) }}".replace("0", id);
    return `<a class="btn" href="${url}" target="_blank">Comprobante</a>`;
  }

  // Grid
  const grid = new Tabulator("#grid", {
    ajaxURL: buildApiUrl(),
    ajaxConfig: { method: "GET", credentials: "same-origin" }, // envía cookie de sesión
    ajaxContentType: "json",
    ajaxResponse:function(url, params, response){
      console.log("Filas recibidas:", Array.isArray(response) ? response.length : response);
      return response; // Tabulator espera un array
    },
    ajaxError:function(xhr){
      console.error("API error", xhr.status, xhr.responseText);
      alert("Error cargando datos (" + xhr.status + "): " + (xhr.responseText || ''));
    },
    index: "id",
    layout: "fitColumns",
    height: "68vh",
    placeholder: "Sin registros.",
    columns: [
      {title:"ID", field:"id", width:70},
      {title:"Fecha", field:"fecha_operacion", hozAlign:"center"},
      {title:"Banco", field:"banco"},
      {title:"Forma", field:"forma_pago"},
      {title:"Producto", field:"producto"},
      {title:"Usuario", field:"numero_usuario"},
      {title:"Importe", field:"importe", hozAlign:"right"},
      {title:"BBVA tipo", field:"bbva_tipo"},
      {title:"Folio", field:"folio"},
      {title:"Autorización", field:"autorizacion"},
      {title:"Referencia", field:"referencia"},
      {title:"Factura", field:"requiere_factura", formatter:"tickCross", hozAlign:"center", width:90},
      {title:"Estatus", field:"estatus"},
      {title:"Obs.", field:"observaciones", width:220},
      {title:"", field:"comprobante_id", formatter:comprobanteFormatter, width:140, hozAlign:"center"},
    ],
  });

  // Acciones de barra
  document.getElementById('btn-filtrar').onclick = () => grid.setData(buildApiUrl());
  document.getElementById('btn-limpiar').onclick = () => {
    document.getElementById('f-usuario').value = "";
    document.getElementById('f-banco').value = "";
    document.getElementById('f-forma').value = "";
    grid.setData(buildApiUrl());
  };
  document.getElementById('btn-csv').onclick = () => grid.download('csv', 'depositos.csv');

  // Carga inicial
  grid.setData(buildApiUrl());
</script>
</body>
</html>
