{% extends "base.html" %}
{% block title %}Registro de Depósito · Multisaldo{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-lg-10 col-xl-9">
    <div class="card shadow-sm">
      <div class="card-body p-4">
        <h3 class="mb-3"><i class="bi bi-ui-checks-grid me-2"></i>Registro de Depósito</h3>
        <p class="text-secondary mb-4">Captura todos los campos obligatorios. Los comprobantes se almacenan de forma segura.</p>

        <form method="post" enctype="multipart/form-data" id="registroForm" novalidate>
          <!-- Banco / Forma / Producto bloqueado en una tarjeta -->
          <div class="border rounded-3 p-3 mb-3">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label fw-semibold">Banco</label>
                <div class="d-flex flex-wrap gap-3">
                  {% for b in bancos %}
                    <div class="form-check form-check-inline">
                      <input class="form-check-input bank-radio" type="radio" name="banco" id="b_{{b}}" value="{{b}}" {% if loop.first %}checked{% endif %} required>
                      <label class="form-check-label" for="b_{{b}}">{{b}}</label>
                    </div>
                  {% endfor %}
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label fw-semibold">Forma de pago</label>
                <div class="d-flex flex-wrap gap-3">
                  {% for f in formas %}
                    <div class="form-check form-check-inline">
                      <input class="form-check-input pay-radio" type="radio" name="forma_pago" id="f_{{f}}" value="{{f}}" {% if loop.first %}checked{% endif %} required>
                      <label class="form-check-label" for="f_{{f}}">{{f}}</label>
                    </div>
                  {% endfor %}
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label fw-semibold">Fecha de operación</label>
                <input type="date" class="form-control" name="fecha_operacion" required>
              </div>

              <div class="col-md-6">
                <label class="form-label fw-semibold">Producto</label>
                <div class="d-flex flex-wrap gap-3">
                  {% for p in productos %}
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="producto" id="p_{{p}}" value="{{p}}" {% if loop.first %}checked{% endif %} required>
                      <label class="form-check-label" for="p_{{p}}">{{p}}</label>
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>

          <!-- Importe -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Importe</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input class="form-control" name="importe" inputmode="decimal" placeholder="0.00" required>
            </div>
          </div>

          <!-- Lógica BBVA -->
          <div id="bbvaTipoWrap" class="mb-3 d-none">
            <label class="form-label fw-semibold">Tipo BBVA (solo para Depósito)</label>
            <div class="d-flex flex-wrap gap-3">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="bbva_tipo" id="bb_practicaja" value="practicaja" checked>
                <label class="form-check-label" for="bb_practicaja">Practicaja</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="bbva_tipo" id="bb_caja" value="caja">
                <label class="form-check-label" for="bb_caja">Caja</label>
              </div>
            </div>
          </div>

          <div id="bbvaPracticaja" class="row g-3 mb-3 d-none">
            <div class="col-md-6">
              <label class="form-label">Folio (4 dígitos)</label>
              <input class="form-control" name="folio_practicaja" pattern="\\d{4}" inputmode="numeric" placeholder="Ej. 4457">
              <div class="form-text">Ejemplo del ticket: <span class="text-monospace">Folio=4457</span></div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Autorización (6 dígitos)</label>
              <input class="form-control" name="autorizacion" pattern="\\d{6}" inputmode="numeric" placeholder="Ej. 347142">
            </div>
          </div>

          <div id="bbvaCaja" class="mb-3 d-none">
            <label class="form-label">Folio (Caja)</label>
            <input class="form-control" name="folio_movimiento" placeholder="Número de movimiento/folio" />
          </div>

          <div id="otrosBancos" class="mb-3">
            <label class="form-label">Movimiento o folio</label>
            <input class="form-control" name="folio_unico" placeholder="Referencia / folio">
          </div>

          <!-- Usuario + comprobante -->
          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <label class="form-label fw-semibold">Número de usuario (5 dígitos)</label>
              <input class="form-control" name="numero_usuario" pattern="\\d{5}" inputmode="numeric" required placeholder="12345">
            </div>
            <div class="col-md-8">
              <label class="form-label fw-semibold">Comprobante (JPG/PNG/PDF)</label>
              <input class="form-control" type="file" name="comprobante" accept=".jpg,.jpeg,.png,.pdf" required>
            </div>
          </div>

          <!-- Factura -->
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="reqFact" name="requiere_factura">
            <label class="form-check-label fw-semibold" for="reqFact">Requiere factura</label>
          </div>
          <div id="facturaOpciones" class="mb-3 d-none">
            <div class="small text-secondary mb-2">Selecciona la razón social asignada a este usuario:</div>
            <div id="cardsFactura" class="row g-3"></div>
            <input type="hidden" name="factura_opcion_id" id="factura_opcion_id">
            <div class="small text-secondary mt-1" id="facturaHint">Ingresa primero el número de usuario (5 dígitos).</div>
          </div>

          <!-- Observaciones -->
          <div class="mb-4">
            <label class="form-label">Observaciones (opcional)</label>
            <textarea class="form-control" name="observaciones" rows="3" placeholder="Notas adicionales..."></textarea>
          </div>

          <div class="d-flex gap-2">
            <button class="btn btn-primary"><i class="bi bi-send"></i> Enviar</button>
            <a class="btn btn-outline-secondary" href="https://www.multisaldo.com.mx/#ptoventa.jproductos/"><i class="bi bi-arrow-left"></i> Regresar a Multi Saldo</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block body_extra %}
<script>
  // --- lógica de visibilidad BBVA/practicaja/caja/otros ---
  function refreshBBVA() {
    const bank = document.querySelector('input[name="banco"]:checked')?.value;
    const forma = document.querySelector('input[name="forma_pago"]:checked')?.value;

    const wTipo = document.getElementById('bbvaTipoWrap');
    const wPrac = document.getElementById('bbvaPracticaja');
    const wCaja = document.getElementById('bbvaCaja');
    const wOtros = document.getElementById('otrosBancos');

    const isBBVA = bank === 'BBVA';
    const isDeposito = forma === 'Deposito';

    // reset mínimos
    wTipo.classList.toggle('d-none', !(isBBVA && isDeposito));
    wPrac.classList.add('d-none'); wCaja.classList.add('d-none');

    if (isBBVA && isDeposito) {
      const t = document.querySelector('input[name="bbva_tipo"]:checked')?.value || 'practicaja';
      if (t === 'practicaja') { wPrac.classList.remove('d-none'); }
      if (t === 'caja')       { wCaja.classList.remove('d-none'); }
      wOtros.classList.add('d-none');
    } else {
      wOtros.classList.remove('d-none');
    }
  }
  document.querySelectorAll('.bank-radio,.pay-radio,input[name="bbva_tipo"]').forEach(el => {
    el.addEventListener('change', refreshBBVA);
  });
  refreshBBVA();

  // --- factura: cargar opciones por usuario ---
  const reqFact = document.getElementById('reqFact');
  const factWrap = document.getElementById('facturaOpciones');
  const cards = document.getElementById('cardsFactura');
  const inputUser = document.querySelector('input[name="numero_usuario"]');
  const hiddenId = document.getElementById('factura_opcion_id');
  function renderCards(items) {
    cards.innerHTML = '';
    if (!items.length) {
      cards.innerHTML = '<div class="text-secondary">No hay opciones registradas para ese usuario.</div>';
      hiddenId.value = '';
      return;
    }
    for (const it of items) {
      const col = document.createElement('div');
      col.className = 'col-md-6 col-lg-4';
      col.innerHTML = `
        <div class="card h-100 hover-card cursor-pointer" data-id="${it.id}">
          <div class="card-body">
            <div class="fw-semibold">${it.titulo}</div>
            <div class="small text-secondary">RFC: ${it.rfc || '-'}</div>
            <div class="small text-secondary">${it.email || ''}</div>
          </div>
        </div>`;
      col.querySelector('.card').addEventListener('click', () => {
        document.querySelectorAll('#cardsFactura .card').forEach(c => c.classList.remove('selected-card'));
        col.querySelector('.card').classList.add('selected-card');
        hiddenId.value = it.id;
      });
      cards.appendChild(col);
    }
  }
  async function fetchOpciones() {
    hiddenId.value = '';
    cards.innerHTML = '';
    if (!/^\d{5}$/.test(inputUser.value)) return;
    try {
      const q = new URLSearchParams({ numero_usuario: inputUser.value });
      const resp = await fetch(`/api/opciones_factura?${q}`);
      const data = await resp.json();
      renderCards(data);
    } catch (e) {
      console.error(e);
    }
  }
  inputUser.addEventListener('input', () => { if (reqFact.checked) fetchOpciones(); });
  reqFact.addEventListener('change', () => {
    factWrap.classList.toggle('d-none', !reqFact.checked);
    if (reqFact.checked) fetchOpciones();
  });
</script>
{% endblock %}
